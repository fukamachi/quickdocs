
(:TYPE :SYSTEM :NAME "pettomato-indexed-priority-queue" :AUTHOR
 "Austin Haas <austin@pettomato.com>" :MAINTAINER NIL :VERSION "0.1.3" :LICENCE
 "MIT" :DESCRIPTION
 "A binary heap based priority queue implementation with efficient support for find, update, replace, and delete operations."
 :LONG-DESCRIPTION NIL :DEPENDS-ON NIL :PACKAGE-LIST
 ((:TYPE :PACKAGE :NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :FULL-NAME
   "PETTOMATO-INDEXED-PRIORITY-QUEUE" :DOCUMENTATION NIL :SYMBOL-LIST
   ((:TYPE :CONSTANT :SYMBOL
     (:NAME "+NOT-IN-QUEUE+" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP NIL)
     :DOCUMENTATION
     "A sentinel value associated with an item that is not in the queue."
     :INITIAL-VALUE "-1")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "PARENT" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP NIL)
     :LAMBDA-LIST
     ((:NAME "I" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION NIL)
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "LEFT" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
      NIL)
     :LAMBDA-LIST
     ((:NAME "I" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION NIL)
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "RIGHT" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
      NIL)
     :LAMBDA-LIST
     ((:NAME "I" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION NIL)
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "HEAPIFY" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP NIL)
     :LAMBDA-LIST
     ((:NAME "HEAP" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "I" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "COMPARE-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
       :EXTERNALP NIL)
      (:NAME "SET-INDEX-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
       :EXTERNALP NIL))
     :DOCUMENTATION
     "Assume that the children of i are heaps, but that heap[i] may be
worse than its children. If it is, move heap[i] down where it
belongs. [Page 130 CL&R 2nd ed.].")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "IMPROVE-KEY" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP NIL)
     :LAMBDA-LIST
     ((:NAME "HEAP" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "I" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "COMPARE-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
       :EXTERNALP NIL)
      (:NAME "SET-INDEX-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
       :EXTERNALP NIL))
     :DOCUMENTATION
     "The item at i may be better than its parent. Promote the item until
it is in the correct position.")
    (:TYPE :STRUCT :SYMBOL
     (:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
      NIL)
     :SUPER-CLASS-LIST
     ((:NAME "STRUCTURE-OBJECT" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T))
     :DOCUMENTATION NIL :SLOT-LIST
     ((:TYPE :CLASS-SLOT :SYMBOL
       (:NAME "COMPARE-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
        :EXTERNALP NIL)
       :ACCESSORS NIL :READERS NIL :WRITERS NIL :DOCUMENTATION NIL)
      (:TYPE :CLASS-SLOT :SYMBOL
       (:NAME "SET-INDEX-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
        :EXTERNALP NIL)
       :ACCESSORS NIL :READERS NIL :WRITERS NIL :DOCUMENTATION NIL)
      (:TYPE :CLASS-SLOT :SYMBOL
       (:NAME "GET-INDEX-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
        :EXTERNALP NIL)
       :ACCESSORS NIL :READERS NIL :WRITERS NIL :DOCUMENTATION NIL)
      (:TYPE :CLASS-SLOT :SYMBOL
       (:NAME "ITEMS" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
        :EXTERNALP NIL)
       :ACCESSORS NIL :READERS NIL :WRITERS NIL :DOCUMENTATION NIL)))
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "MAKE-Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP NIL)
     :LAMBDA-LIST
     ((:NAME "&KEY" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (((:NAME "COMPARE-FN" :PACKAGE-NAME "KEYWORD" :EXTERNALP T)
        (:NAME "DUM46" :PACKAGE-NAME NIL :EXTERNALP NIL))
       (:NAME "NIL" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T))
      (((:NAME "SET-INDEX-FN" :PACKAGE-NAME "KEYWORD" :EXTERNALP T)
        (:NAME "DUM47" :PACKAGE-NAME NIL :EXTERNALP NIL))
       (:NAME "NIL" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T))
      (((:NAME "GET-INDEX-FN" :PACKAGE-NAME "KEYWORD" :EXTERNALP T)
        (:NAME "DUM48" :PACKAGE-NAME NIL :EXTERNALP NIL))
       (:NAME "NIL" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T))
      (((:NAME "ITEMS" :PACKAGE-NAME "KEYWORD" :EXTERNALP T)
        (:NAME "DUM49" :PACKAGE-NAME NIL :EXTERNALP NIL))
       (:NAME "NIL" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)))
     :DOCUMENTATION NIL)
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "MAKE-EMPTY-QUEUE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "COMPARE-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
       :EXTERNALP NIL)
      (:NAME "SET-INDEX-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
       :EXTERNALP NIL)
      (:NAME "GET-INDEX-FN" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
       :EXTERNALP NIL)
      (:NAME "&KEY" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      ((:NAME "SIZE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
        :EXTERNALP NIL)
       100))
     :DOCUMENTATION "Return a new empty queue.

compare-fn is a function that takes two arguments and returns a true
value iff the first argument should be prioritized higher in the
queue. If the two items have equal priority, then compare-fn should
return nil.

set-index-fn and get-index-fn are a pair. Some queue operations (e.g.,
queue-delete) require that the index for an item can be
retrieved. These functions allow the user to control how that mapping
is maintained.

set-index-fn is a function that takes two arguments: the first is an
item in the queue and the second is the current index position of that
item in the heap. This function should do something to record the
association between the item and the index. Each item's index may
change many times while it is stored in the queue; this function will
be called each time.

get-index-fn is a function that takes an item and returns the heap
index that was associated with it via set-index-fn. get-index-fn must
return -1 if the item is not in the queue. The priority queue will
call set-index-fn with -1 when an item is being removed from the
queue, but that obviously only works for items it has seen before. If
there is a chance client code will try to call one of the operations
that relies on get-index-fn with items that have never been in the
queue, you must make sure that get-index-fn returns -1. See example
below.

A trivial way to implement set-index-fn / get-index-fn would be like
this:

 (let* ((hash (make-hash-table))
        (set-index-fn (lambda (item index))
                         (setf (gethash item hash) index))
        (get-index-fn (lamda (item)
                         (gethash item hash -1))))
   (make-empty-queue #'< set-index-fn get-index-fn))

Notice that get-index-fn returns -1 for items that aren't in the
hash. It might also be a good idea to change set-index-fn to something
like this:

 (lambda (item index)
    (if (= index -1)
        (remhash item hash)
        (setf (gethash item hash) index)))

Of course, this code all depends on each item being distinguishable
via 'eql, since that is the default test for a hash-table.

The motivation for handling the index maintenance this way is that it
is straightforward and flexible. Any item can be stored in the queue
and the user has control over how they are identified and where this
storage takes place. In many cases, it may make sense to store the
index directly as a property of the item being stored. In other cases,
we may want a looser mapping that only uses some attributes of the
item being stored, so that we can lookup similar items (e.g., if we
were using the priority queue in a search algorithm we could check to
see if the queue already contains a node with the same state as a
newly discovered node).
")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-SIZE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION NIL)
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-EMPTY-P" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION "Are there no items in the queue?")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-PEEK" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION "Return the element at the front of the queue. Signals
empty-queue-error if the queue is empty.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-POP" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION "Remove the element from the front of the queue and return
it. Signals empty-queue-error if the queue is empty. [Page 139 CL&R
2nd ed.].")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-INSERT" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "ITEM" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION "Insert the item by priority according to the compare
function. Returns the queue. [Page 140 CL&R 2nd ed.].")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-REPLACE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "OLD" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "NEW" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION
     "Replace old with new in the queue. This is analogous to deleting
the old item and inserting the new one, but it is almost always more
efficient (and never less efficient) because we can just fix up the
heap from the position of the swapped item. Obviously, this only makes
sense if you expect the two items to be located very close to each
other in the queue (perhaps even in the same location, such as if the
priority is the same, but you need to swap the item being stored
because of other data it contains). Returns the queue. Signals
item-not-found-error if the old item wasn't found.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-UPDATE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "ITEM" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION
     "queue-update makes sure that item is sorted correctly in q. Call
queue-update after changing item in such a way that would affect its
priority. Returns the queue. Signals item-not-found-error if the item
wasn't found.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-DELETE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "ITEM" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION "Delete item from the queue. Returns the queue. Signals
empty-queue-error if the queue is empty. Signals item-not-found-error
if the item wasn't found.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "QUEUE-FIND" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "Q" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL)
      (:NAME "ITEM" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP
       NIL))
     :DOCUMENTATION "Checks if item is in the queue (using the supplied
get-index-fn). If it is, returns two values: the actual item from the
queue (which could be different than the supplied item, since the
client can setup the mapping however they like) and the index. If it
isn't, returns nil and -1."))
   :EXTERNAL-SYMBOLS
   ((:NAME "QUEUE-SIZE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "QUEUE-PEEK" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "QUEUE-INSERT" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "QUEUE-POP" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "QUEUE-UPDATE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "QUEUE-EMPTY-P" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "QUEUE-REPLACE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "MAKE-EMPTY-QUEUE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "QUEUE-DELETE" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "ITEM-NOT-FOUND-ERROR" :PACKAGE-NAME
     "PETTOMATO-INDEXED-PRIORITY-QUEUE" :EXTERNALP T)
    (:NAME "QUEUE-FIND" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)
    (:NAME "EMPTY-QUEUE-ERROR" :PACKAGE-NAME "PETTOMATO-INDEXED-PRIORITY-QUEUE"
     :EXTERNALP T)))))
