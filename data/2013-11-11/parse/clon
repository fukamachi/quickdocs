
(:TYPE :SYSTEM :NAME "clon" :AUTHOR "GÃ¡bor Melis <mega@retes.hu>" :MAINTAINER
 NIL :VERSION "0.0.2" :LICENCE NIL :DESCRIPTION NIL :LONG-DESCRIPTION NIL
 :DEPENDS-ON ("BORDEAUX-THREADS" "TRIVIAL-TIMERS") :PACKAGE-LIST
 ((:TYPE :PACKAGE :NAME "CLON" :FULL-NAME "CLON" :DOCUMENTATION NIL
   :SYMBOL-LIST
   ((:TYPE :VARIABLE :SYMBOL
     (:NAME "*DEFAULT-NEXT-TIME-LIMIT*" :PACKAGE-NAME "CLON" :EXTERNALP T)
     :DOCUMENTATION "The default time limit for NEXT-TIME searches."
     :INITIAL-VALUE "(ENCODE-UNIVERSAL-TIME 0 0 0 1 1 3000)")
    (:TYPE :GENERIC :SYMBOL
     (:NAME "NEXT-TIME" :PACKAGE-NAME "CLON" :EXTERNALP T) :LAMBDA-LIST
     ((:NAME "SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "&KEY" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "NOW" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "ALLOW-NOW-P" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "LIMIT" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION "Return the next time according to SCHEDULE or NIL
if there is no next time. If ALLOW-NOW-P the earliest possible time to
be returned is NOW, else it is usually NOW + the resolution of the
schedule. The default value of NOW is (GET-UNIVERSAL-TIME),
ALLOW-NOW-P is NIL and LIMIT is *DEFAULT-NEXT-TIME-LIMIT*")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "MAKE-SCHEDULER" :PACKAGE-NAME "CLON" :EXTERNALP T) :LAMBDA-LIST
     ((:NAME "SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "&KEY" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      ((:NAME "NOW" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
       ((:NAME "GET-UNIVERSAL-TIME" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)))
      (:NAME "ALLOW-NOW-P" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      ((:NAME "LIMIT" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
       (:NAME "*DEFAULT-NEXT-TIME-LIMIT*" :PACKAGE-NAME "CLON" :EXTERNALP T)))
     :DOCUMENTATION
     "Return a `scheduler' function of no arguments that returns times
from NOW on by repeatedly calling NEXT-TIME on SCHEDULE. ALLOW-NOW-P
is passed to the first invocation of NEXT-TIME.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "SCHEDULE-FUNCTION" :PACKAGE-NAME "CLON" :EXTERNALP T) :LAMBDA-LIST
     ((:NAME "FUNCTION" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "SCHEDULER" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "&KEY" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "NAME" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      ((:NAME "THREAD" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
       ((:NAME "CURRENT-THREAD" :PACKAGE-NAME "BORDEAUX-THREADS" :EXTERNALP
         T))))
     :DOCUMENTATION
     "Create a timer just as with TRIVIAL-TIMERS:MAKE-TIMER but schedule
and reschedule FUNCTION according to SCHEDULER that is a function of
no parameters that returns a universal time or NIL. The returned timer
can be shut down with TRIVIAL-TIMERS:UNSCHEDULE-TIMER.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "DECODE-UNIVERSAL-TIME*" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
     :LAMBDA-LIST ((:NAME "TIME" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T))
     :DOCUMENTATION
     "Return the decoded time components as a list instead of multiple
values.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "ENCODE-UNIVERSAL-TIME*" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
     :LAMBDA-LIST ((:NAME "DECODED-TIME" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "Encode DECODED-TIME that is a decoded time in list form such as one
that was returned by DECODE-UNIVERSAL-TIME*.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "DAYS-OF-MONTH" :PACKAGE-NAME "CLON" :EXTERNALP NIL) :LAMBDA-LIST
     ((:NAME "DECODED-TIME" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION "Return the number of days in the month DECODED-TIME.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "MIN-VALID-DECODED-TIME-COMPONENT" :PACKAGE-NAME "CLON" :EXTERNALP
      NIL)
     :LAMBDA-LIST ((:NAME "N" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "Return the smallest valid value for the Nth decoded time component.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "MAX-VALID-DECODED-TIME-COMPONENT" :PACKAGE-NAME "CLON" :EXTERNALP
      NIL)
     :LAMBDA-LIST
     ((:NAME "N" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "&OPTIONAL" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "DECODED-TIME" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION "Return the largest valid value for the Nth component of
DECODED-TIME or NIL if there is no limit. Passing DECODED-TIME is
necessary only for the day of month component because the number of
days in a month varies.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "VALID-DECODED-TIME-COMPENENT-P" :PACKAGE-NAME "CLON" :EXTERNALP
      NIL)
     :LAMBDA-LIST
     ((:NAME "N" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "VALUE" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "See if value can ever be a valid value as the Nth component of a
decoded time.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "ZERO-DECODED-TIME-BELOW" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
     :LAMBDA-LIST
     ((:NAME "DECODED-TIME" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "N" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION "Set the first N components of DECODED-TIME to their
MIN-VALID-DECODED-TIME-COMPONENT values.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "BUMP-DECODED-TIME" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
     :LAMBDA-LIST
     ((:NAME "TIME" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "N" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "&OPTIONAL" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      ((:NAME "M" :PACKAGE-NAME "CLON" :EXTERNALP NIL) 1))
     :DOCUMENTATION
     "Increment the Nth component of decoded TIME, handle overflows, zero
the lower components. Return changed decoded time and the highest index
that was changed.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "NEXT-BUMP" :PACKAGE-NAME "CLON" :EXTERNALP NIL) :LAMBDA-LIST
     ((:NAME "BUMPER" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "DECODED-TIME" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "N" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "Invoke BUMPER on the Nth component of DECODED-TIME. Return its
value if it can ever be valid (not necessarily in the context of
DECODED-TIME) or else NIL.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "BUMP-DAY-OF-MONTH-AND-DAY-OF-WEEK" :PACKAGE-NAME "CLON" :EXTERNALP
      NIL)
     :LAMBDA-LIST
     ((:NAME "DOM-BUMPER" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "DOW-BUMPER" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "DECODED-TIME" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "Extra hair due to the circular dependency between DAY-OF-MONTH and
DAY-OF-WEEK bumpers. This function rolls the two bumpers into one.")
    (:TYPE :CLASS :SYMBOL
     (:NAME "CRON-SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP T)
     :SUPER-CLASS-LIST NIL :DOCUMENTATION
     "A cron-like schedule. See MAKE-CRON-SCHEDULE for details." :SLOT-LIST
     ((:TYPE :CLASS-SLOT :SYMBOL
       (:NAME "BUMPERS" :PACKAGE-NAME "CLON" :EXTERNALP NIL) :ACCESSORS NIL
       :READERS ((:NAME "BUMPERS" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
       :WRITERS NIL :DOCUMENTATION
       "The bumpers in decoded time component order.")))
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "MAKE-CRON-SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "&KEY" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "SECOND" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "MINUTE" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "HOUR" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "DAY-OF-MONTH" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "MONTH" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "YEAR" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "DAY-OF-WEEK" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "Construct a cron-like scheduler from the SECOND, MINUTE, etc
bumpers for components of decoded times (using the default time zone
for the time being). A bumper in its most generic from a function of
three arguments: the current value, the whole decoded time, and the
index of the current value in the decoded time. A bumper is expected
to return the smallest value that is valid for that component and not
less than the current value or NIL if it cannot find a valid value.
Returning a value that is smaller than the current one is the same as
returning NIL. A bumper can simply be a number which is equivalent to
(CONSTANTLY NUMBER).

Bumpers are not allowed to depend on `lower' components of the decoded
time. The allowed dependency graph is this:

SECOND -> MINUTE -> HOUR -> (DAY-OF-MONTH <-> DAY-OF-WEEK) -> MONTH -> YEAR

That is, the SECOND bumper may look at the whole decoded time but the
MINUTE bumper may not look at seconds. DAY-OF-WEEK and DAY-OF-MONTH
may depend on each other to allow specifying the 'last Friday of the
month'.

The resolution of the schedule is defined implicitly by the lowest
bumper. NEXT-TIME always bumps the component of the decoded time that
belongs to the lowest bumper before trying to find mathces if its
LAST-TIME argument is not NIL. Of course, DAY-OF-WEEK is the odd one
out: it is the day-of-month component that is bumped if DAY-OF-WEEK is
the lowest bumper.

This scheme allows (MAKE-CRON-SCHEDULE :MONTH 12) trigger only once
per year instead of every second in December. For a more packed
schedule one can use the symbol '* as a bumper: (MAKE-CRON-SCHEDULE
:HOUR '* :MONTH 12) which makes hour the lowest bumper and the
schedule triggers every hour in December.

It is an error if all bumpers are NIL.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "BUMPER-INDEX->COMPONENT-INDEX" :PACKAGE-NAME "CLON" :EXTERNALP
      NIL)
     :LAMBDA-LIST ((:NAME "I" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "Return the index of the decoded time component that is effect by
bumper I. Day of week is lumped together with day of month.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "LOWEST-COMPONENT-INDEX-WITH-A-BUMPER" :PACKAGE-NAME "CLON"
      :EXTERNALP NIL)
     :LAMBDA-LIST ((:NAME "BUMPERS" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "Return the the index of what is basically the root of current
dependency graph.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "BUMP-LOWEST-COMPONENT" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
     :LAMBDA-LIST
     ((:NAME "BUMPERS" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "TIME" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T))
     :DOCUMENTATION
     "Bump the lowest component of decoded TIME that has a bumper. Return
it as a universal time.")
    (:TYPE :METHOD :SYMBOL
     (:NAME "NEXT-TIME" :PACKAGE-NAME "CLON" :EXTERNALP T) :LAMBDA-LIST
     (((:NAME "SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
       (:NAME "CRON-SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP T))
      (:NAME "&KEY" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      ((:NAME "NOW" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
       ((:NAME "GET-UNIVERSAL-TIME" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)))
      (:NAME "ALLOW-NOW-P" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      ((:NAME "LIMIT" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
       (:NAME "*DEFAULT-NEXT-TIME-LIMIT*" :PACKAGE-NAME "CLON" :EXTERNALP T)))
     :DOCUMENTATION NIL)
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "FIND-DECODED-TIME-COMPONENT-BY-TYPE" :PACKAGE-NAME "CLON"
      :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "TYPE" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "VALUE" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "DECODED-TIME" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "N" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "Return the first valid value not less than VALUE that is of TYPE.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "MAKE-TYPED-CRON-BUMPER" :PACKAGE-NAME "CLON" :EXTERNALP T)
     :LAMBDA-LIST ((:NAME "TYPE" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T))
     :DOCUMENTATION
     "Return a bumper function suitable for MAKE-CRON-SCHEDULE that
returns the first valid value according to TYPE. Convenience function
on top of FIND-DECODED-TIME-COMPONENT-BY-TYPE.")
    (:TYPE :FUNCTION :SYMBOL
     (:NAME "MAKE-TYPED-CRON-SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP T)
     :LAMBDA-LIST
     ((:NAME "&KEY" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "SECOND" :PACKAGE-NAME "COMMON-LISP" :EXTERNALP T)
      (:NAME "MINUTE" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "HOUR" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "DAY-OF-MONTH" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "MONTH" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "YEAR" :PACKAGE-NAME "CLON" :EXTERNALP NIL)
      (:NAME "DAY-OF-WEEK" :PACKAGE-NAME "CLON" :EXTERNALP NIL))
     :DOCUMENTATION
     "A convenience function much like MAKE-CRON-SCHEDULE but assumes
that no bumper can be a function designator so it must be a number,
the symbol * or a type specifier in which case it calls
MAKE-TYPED-CRON-BUMPER on it providing a terser syntax."))
   :EXTERNAL-SYMBOLS
   ((:NAME "FIND-DECODED-TIME-COMPONENT-BY-TYPE" :PACKAGE-NAME "CLON"
     :EXTERNALP T)
    (:NAME "*DEFAULT-NEXT-TIME-LIMIT*" :PACKAGE-NAME "CLON" :EXTERNALP T)
    (:NAME "MAKE-TYPED-CRON-BUMPER" :PACKAGE-NAME "CLON" :EXTERNALP T)
    (:NAME "MAKE-CRON-SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP T)
    (:NAME "SCHEDULE-FUNCTION" :PACKAGE-NAME "CLON" :EXTERNALP T)
    (:NAME "MAKE-TYPED-CRON-SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP T)
    (:NAME "NEXT-TIME" :PACKAGE-NAME "CLON" :EXTERNALP T)
    (:NAME "CRON-SCHEDULE" :PACKAGE-NAME "CLON" :EXTERNALP T)
    (:NAME "MAKE-SCHEDULER" :PACKAGE-NAME "CLON" :EXTERNALP T)))))
